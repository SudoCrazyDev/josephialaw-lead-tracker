# Deploy to EC2 (t2.medium) via SSH â€” Docker + Nginx
# Add secrets: EC2_HOST, EC2_SSH_KEY, EC2_USER (e.g. ubuntu)

name: Deploy to EC2

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up SSH
        run: |
          mkdir -p ~/.ssh
          echo "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAACAQDXdbCQ0jiSBnvjvg+eYQCM2Os8yIQJPysoZBFX2EmrtTyCRgDW2UOvd6v/dRoWp/Yobl29x2QefqSnWJBHCrTLeAUgyTOuxTKrEOxLUS1D1oHC/fsJu+J3uXusd6Y8ALnG7N/9Amol7F1iN+Xa17C8Cs8PGQyiroQGLSWGsx52hdYWEdxrrb+Sal/tEpuniCob8TKk6yqNeO71dWhu9LfwflodSALbSNbYFyq+tz6bCLO0KmyLKVfdLDNNr/9l7FlTN059tKnC2frZ+9TGBjfzCz3eiXGRhBjmvC41BxA2U23OTuBc7i2HU7dk5VibSvqzdf2ZZkzRyG1IJRjbVYkGEwf0WFpVWK3xVt40We1V95qzUu98+ow1+PEin2v8dv9BLjFUpO13n6oJx0exTYh73/Q4RSgX15TeF0pa1Qre/UVfMEecDPtsQ+nfzaEFV2AAWizGHZBHjkYWLZKvXuSa9YJx0X5EHKzwiYsKGwTStHyejFGCyWS9cVDF0ECLkXjBkx3RJjTl58tWKJHrpvdly5mJ0gQ136LIoZvK5fO67XElTf5gYNbSgps268qPl2hgkxuuFrCYoa808lSyZyBqRSVO6/wcJYFy0n8ZFmzN0sr0OVOPrHmMO0go19aI8NJhNTyaqro212vQaXGVB3cdp9iJP1gAW0I1ECholx9xYw== info@josephialaw.com" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H "${{ secrets.EC2_HOST }}" >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Sync files to EC2
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no" \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.env' \
            --exclude '.env.*' \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ vars.EC2_DEPLOY_PATH || '/home/ubuntu/josephia' }}/

      - name: Deploy with Docker Compose
        run: |
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} \
            "cd ${{ vars.EC2_DEPLOY_PATH || '/home/ubuntu/josephia' }} && \
             docker compose build --no-cache && \
             docker compose up -d"

      - name: Clean up SSH key
        if: always()
        run: rm -f ~/.ssh/deploy_key
